<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Chỉnh sửa bài viết</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="bg-light">

<div class="container d-flex justify-content-center align-items-center min-vh-100">
    <div class="card shadow-lg p-4 w-75">
        <h2 class="text-center text-warning mb-4">Chỉnh sửa bài viết</h2>

        <!-- Form chỉnh sửa bài viết -->
        <form th:action="@{/posts/{id}(id=${post.id})}" method="post" enctype="multipart/form-data" th:object="${post}">
            <!-- Field ẩn lưu id bài viết -->
            <input type="hidden" th:field="*{id}">

            <!-- Tiêu đề -->
            <div class="mb-3">
                <label for="title" class="form-label fw-bold">Tiêu đề</label>
                <input type="text" class="form-control" id="title" th:field="*{title}" required>
                <div th:if="${#fields.hasErrors('title')}" th:errors="*{title}" class="text-danger"></div>
            </div>

            <!-- Nội dung -->
            <div class="mb-3">
                <label for="content" class="form-label fw-bold">Nội dung</label>
                <textarea class="form-control" id="content" th:field="*{content}" rows="4" required></textarea>
                <div th:if="${#fields.hasErrors('content')}" th:errors="*{content}" class="text-danger"></div>
            </div>

            <!-- Ngày đăng (hiển thị dd/MM/yyyy và tự động điền ngày hiện tại nếu null) -->
            <div class="mb-3">
                <label for="publishDate" class="form-label fw-bold">Ngày đăng</label>
                <<input type="text" class="form-control" id="publishDate" name="publishDate" required
                        th:value="${#temporals.format(post.publishDate != null ? post.publishDate : T(java.time.LocalDate).now(), 'dd/MM/yyyy')}">

                <div th:if="${#fields.hasErrors('publishDate')}" th:errors="*{publishDate}" class="text-danger"></div>
            </div>

            <!-- Trạng thái -->
            <div class="mb-3">
                <label for="status" class="form-label fw-bold">Trạng thái</label>
                <select class="form-select" id="status" th:field="*{status}" required>
                    <!-- Lựa chọn "Chưa Giao Dịch" luôn hiển thị cho cả SALE và RENT -->
                    <option value="Available" th:selected="${post.status == 'Available'}">Chưa Giao Dịch</option>

                    <!-- Nếu purpose là SALE, hiển thị lựa chọn "Đã Bán" -->
                    <option value="Sold" th:if="${post.purpose == 'SALE'}" th:selected="${post.status == 'Sold'}">Đã Bán</option>

                    <!-- Nếu purpose là RENT, hiển thị lựa chọn "Đã Cho Thuê" -->
                    <option value="Rented" th:if="${post.purpose == 'RENT'}" th:selected="${post.status == 'Rented'}">Đã Cho Thuê</option>
                </select>
                <div th:if="${#fields.hasErrors('status')}" th:errors="*{status}" class="text-danger"></div>
            </div>

            <!-- Mục đích (Purpose) -->
            <div class="mb-3">
                <label for="purpose" class="form-label fw-bold">Mục đích</label>
                <select class="form-select" id="purpose" th:field="*{purpose}" required>
                    <option value="SALE" th:selected="${post.purpose == 'SALE'}">Bán</option>
                    <option value="RENT" th:selected="${post.purpose == 'RENT'}">Cho thuê</option>
                </select>
                <div th:if="${#fields.hasErrors('purpose')}" th:errors="*{purpose}" class="text-danger"></div>
            </div>

            <!-- Loại bất động sản (Type) -->
            <div class="mb-3">
                <label for="type" class="form-label fw-bold">Loại BĐS</label>
                <select class="form-select" id="type" th:field="*{type}" required>
                    <option value="House" th:selected="${post.type == 'House'}">Nhà</option>
                    <option value="Apartment" th:selected="${post.type == 'Apartment'}">Căn hộ</option>
                    <option value="Land" th:selected="${post.type == 'Land'}">Đất</option>
                    <option value="Hotel" th:selected="${post.type == 'Hotel'}">Khách sạn</option>
                    <option value="Building" th:selected="${post.type == 'Building'}">Tòa nhà</option>
                </select>
                <div th:if="${#fields.hasErrors('type')}" th:errors="*{type}" class="text-danger"></div>
            </div>

            <!-- Địa điểm -->
            <div class="mb-3">
                <label for="location" class="form-label fw-bold">Địa điểm</label>
                <input type="text" class="form-control" id="location" th:field="*{location}" required>
                <div th:if="${#fields.hasErrors('location')}" th:errors="*{location}" class="text-danger"></div>
            </div>

            <!-- Diện tích -->
            <div class="mb-3">
                <label for="area" class="form-label fw-bold">Diện tích (m²)</label>
                <input type="number" step="0.01" class="form-control" id="area" th:field="*{area}" required>
                <div th:if="${#fields.hasErrors('area')}" th:errors="*{area}" class="text-danger"></div>
            </div>

            <!-- Hướng -->
            <div class="mb-3">
                <label for="direction" class="form-label fw-bold">Hướng</label>
                <input type="text" class="form-control" id="direction" th:field="*{direction}" required>
                <div th:if="${#fields.hasErrors('direction')}" th:errors="*{direction}" class="text-danger"></div>
            </div>

            <!-- Giá -->
            <div class="mb-3">
                <label for="price" class="form-label fw-bold">Giá</label>
                <input type="number" step="0.01" class="form-control" id="price" th:field="*{price}" required>
                <div th:if="${#fields.hasErrors('price')}" th:errors="*{price}" class="text-danger"></div>
            </div>

            <!-- Hiển thị danh sách ảnh hiện có -->
            <div class="mb-3" th:if="${post.images != null and not post.images.isEmpty()}">
                <label class="form-label fw-bold">Hình ảnh bài viết hiện có</label>
                <div class="d-flex flex-wrap">
                    <div th:each="img : ${post.images}" class="position-relative me-2 mb-2 image-container">
                        <!-- Bọc hình ảnh trong thẻ <a> kích hoạt modal -->
                        <a href="#"
                           data-bs-toggle="modal"
                           data-bs-target="#imageModal"
                           th:attr="data-imgsrc=@{${img.image}}">
                            <img th:src="@{${img.image}}"
                                 alt="Ảnh bài viết"
                                 class="img-fluid rounded"
                                 style="max-width: 150px;">
                        </a>
                        <!-- Checkbox cho xóa ảnh (submit qua form) -->
                        <div class="position-absolute top-0 end-0 bg-white p-1">
                            <input type="checkbox" name="deleteImages" th:value="${img.id}" title="Chọn xóa ảnh này">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Nút Xóa hình đã chọn -->
            <div class="mb-3">
                <button type="button" class="btn btn-danger" onclick="deleteSelectedImages()">Xóa hình đã chọn</button>
            </div>


            <!-- Cập nhật hình ảnh (cho phép chọn nhiều file) -->
            <div class="mb-3">
                <label for="imageFiles" class="form-label fw-bold">Cập nhật hình ảnh (cho phép chọn nhiều file)</label>
                <input type="file" class="form-control" id="imageFiles" name="imageFiles" accept="image/*" multiple>
            </div>

            <!-- Nút Submit và Hủy bỏ -->
            <div class="d-flex justify-content-between">
                <button type="submit"
                        name="action"
                        th:attr="value=${post.payable == 'no' ? 'continue' : 'update'}"
                        class="btn btn-warning w-100 me-2"
                        th:text="${post.payable == 'no' ? 'Tiếp tục' : 'Cập nhật'}">
                </button>
                <a th:href="@{/posts}" class="btn btn-outline-secondary w-100">Hủy bỏ</a>
            </div>

        </form>
    </div>
</div>
<!-- Modal hiển thị hình ảnh -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body p-0">
                <img id="modalImage" src="" class="img-fluid w-100" alt="Xem hình ảnh">
            </div>
        </div>
    </div>
</div>
<script>
    function deleteSelectedImages() {
        // Lấy tất cả các container chứa hình ảnh có class "image-container"
        const imageContainers = document.querySelectorAll('.image-container');
        imageContainers.forEach(container => {
            // Tìm checkbox trong container
            const checkbox = container.querySelector('input[type="checkbox"]');
            if (checkbox && checkbox.checked) {
                // Ẩn container đi tạm thời
                container.style.display = 'none';
            }
        });
    }
    // Sử dụng sự kiện của Bootstrap Modal để cập nhật nguồn hình ảnh cho modal
    var imageModal = document.getElementById('imageModal');
    imageModal.addEventListener('show.bs.modal', function (event) {
        var triggerLink = event.relatedTarget; // phần tử kích hoạt modal
        var imgSrc = triggerLink.getAttribute('data-imgsrc'); // lấy đường dẫn hình ảnh
        var modalImage = document.getElementById('modalImage');
        modalImage.src = imgSrc; // gán vào thẻ img trong modal
    });
</script>

<!-- Bootstrap JS Bundle (bao gồm Popper) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
