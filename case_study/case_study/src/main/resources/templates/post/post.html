<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post Management</title>
    <link rel="stylesheet" href="/style/home.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css">
    <style>
        /* Định nghĩa các class màu cho Post Type */
        .vip-diamond {
            color: #40E0D0; /* xanh ngọc */
        }
        .vip-gold {
            color: #FFD700; /* vàng kim */
        }
        .vip-silver {
            color: #C0C0C0; /* bạc */
        }
        .standard {
            color: #008000; /* xanh lá */
        }
        /* CSS cho card bài đăng */
        .post-card {
            margin-bottom: 20px;
        }
        .post-card img {
            height: 200px;
            object-fit: cover;
        }
    </style>
</head>
<body>
<!-- Chèn header (giữ nguyên phần header từ layout của bạn) -->
<div th:insert="~{/layout/layout::header}"></div>

<div class="container mt-5">
    <h1 class="mb-4 text-center">Post Management</h1>

    <!-- Search Box -->
    <div class="mb-4">
        <input type="text" id="search" class="form-control" placeholder="Search post by title..."
               onkeyup="searchPost()">
    </div>

    <!-- Danh sách bài đăng: mỗi hàng chứa 1 bài đăng -->
    <div id="postContainer">
        <!-- Duyệt qua danh sách bài đăng -->
        <div class="row mb-3" th:each="post : ${posts}">
            <div class="col-md-12">
                <!-- Card: toàn bộ card có thuộc tính onclick để chuyển đến trang chi tiết
                     Lưu ý: Khách vãng lai (không đăng nhập) vẫn có thể click vào card để xem bài đăng -->
                <div class="card post-card" style="cursor: pointer;"
                     th:onclick="|window.location.href='@{/posts/{id}(id=${post.id})}'|">
                <!-- Hình ảnh bài đăng: nếu không có thì hiển thị ảnh placeholder -->
                    <img th:src="${post.image != null} ? @{${post.image}} : 'https://via.placeholder.com/300'"
                         class="card-img-top" alt="Post Image"
                         onerror="this.onerror=null;this.src='https://via.placeholder.com/300'">
                    <div class="card-body">
                        <!-- Tiêu đề bài đăng -->
                        <h5 class="card-title" th:text="${post.title}">Post Title</h5>
                        <!-- Loại VIP -->
                        <p class="card-text">
                                <span th:text="${post.postType.typeName}"
                                      th:class="${#strings.toUpperCase(post.postType.typeName) == 'VIP_DIAMOND' ? 'vip-diamond' :
                                                 (#strings.toUpperCase(post.postType.typeName) == 'VIP_GOLD' ? 'vip-gold' :
                                                 (#strings.toUpperCase(post.postType.typeName) == 'VIP_SILVER' ? 'vip-silver' : 'standard'))}">
                                </span>
                        </p>
                        <!-- Giá bán: Giả sử giá được lấy từ post.realEstate.price -->
                        <p class="card-text">
                            Giá bán: <span th:text="${post.realEstate != null ? post.realEstate.price : 'N/A'}">N/A</span>
                        </p>
                        <!-- Người đăng bài -->
                        <p class="card-text">
                            Người đăng: <span th:text="${post.user.fullName}">User Name</span>
                        </p>
                    </div>
                    <!-- Các nút hành động (Edit & Delete) chỉ hiển thị khi người dùng đã đăng nhập và là người đăng bài.
                         Sử dụng event.stopPropagation() để ngăn không cho click vào nút kích hoạt chuyển hướng của card -->
                    <div class="card-footer text-end">
                        <a class="btn btn-warning btn-sm"
                           th:if="${#authentication.name == post.user.account.username}"
                           th:href="@{/posts/{id}/edit(id=${post.id})}"
                           onclick="event.stopPropagation();">Edit</a>
                        <button type="button" class="btn btn-danger btn-sm"
                                th:if="${#authentication.name == post.user.account.username}"
                                th:attr="data-post-id=${post.id}"
                                onclick="event.stopPropagation(); openDeleteModal(this)">Delete</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Nếu danh sách bài đăng rỗng -->
        <div class="row" th:if="${posts.isEmpty()}">
            <div class="col-12">
                <p class="text-center text-muted">Chưa có bài viết nào. Hãy thêm bài viết mới!</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal xác nhận xóa -->
<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmationModalLabel">Xác nhận xóa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                Bạn có chắc chắn muốn xóa bài đăng này không? Thao tác này không thể hoàn tác.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteButton">Xóa</button>
            </div>
        </div>
    </div>
</div>

<!-- Form ẩn dùng để submit xóa bài đăng -->
<form id="deletePostForm" method="post" style="display: none;">
    <input type="hidden" name="_method" value="delete">
</form>

<!-- Tải Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Hàm tìm kiếm bài đăng theo tiêu đề (dựa vào card title)
    function searchPost() {
        let input = document.getElementById("search").value.toLowerCase();
        let rows = document.querySelectorAll("#postContainer .row.mb-3");
        rows.forEach(function(row) {
            let title = row.querySelector(".card-title").innerText.toLowerCase();
            row.style.display = title.includes(input) ? "" : "none";
        });
    }

    // Biến lưu lại ID của bài đăng được chọn để xóa
    let currentPostId = null;

    // Hàm mở modal xác nhận xóa
    function openDeleteModal(button) {
        currentPostId = button.getAttribute('data-post-id');
        console.log("Post ID selected for deletion:", currentPostId);
        const modalElem = document.getElementById('deleteConfirmationModal');
        if (!modalElem) {
            console.error("Modal element not found!");
            return;
        }
        const modal = new bootstrap.Modal(modalElem);
        modal.show();
    }

    // Gán sự kiện cho nút xác nhận xóa sau khi DOM sẵn sàng
    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('confirmDeleteButton').addEventListener('click', function () {
            document.getElementById('deletePostForm').action = '/posts/' + currentPostId + '/delete';
            document.getElementById('deletePostForm').submit();
        });
    });
</script>
</body>
</html>
